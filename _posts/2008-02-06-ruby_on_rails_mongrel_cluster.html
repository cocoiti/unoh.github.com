---
layout: post
title: "Ruby on Rails: mongrel_clusterのフロントエンドに nginxを使用する"
---
{% raw %}
こんにちは satoです。<br />
<br />
nginx(えんじんえっくす)はロシアで開発されているwebサーバで、軽量、高速が売りのようです。もちろんvirtualhostやrewrite機能にも対応しています。今回はmongrel_clusterのフロントエンドに使ってみました。<br />
<h3>mongrel_railsのインストールと環境構築</h3><br />
mongrel_railsをインストールします<br />
<pre class="code">gem istall mongrel_cluster --include-dependencies</pre><br />
設定ファイルを作ります。RAIL_ROOTで<br />
<pre class="code">mongrel_rails cluster::configure -e development -p 4000</pre><br />
とすると RAILS_ROOT/conf/mongrel_cluster.yml ができます。<br />
<pre class="code">--- <br />
log_file: log/mongrel.log<br />
port: "4000"<br />
environment: development<br />
pid_file: tmp/pids/mongrel.pid<br />
servers: 2</pre><br />
mongrel_clusterを起動します。<br />
<pre class="code">mongrel_rails cluster::start</pre><br />
<br />
<br />
<h3>nginxのインストールと環境構築</h3><br />
nginxは URIのrewrite機能 等に  pcre を使うので、 pcre-develをインストールしておきます。<br />
<pre class="code">yum install pcre-devel</pre><br />
nginxをソースから入れます<br />
<pre class="code">wget http://sysoev.ru/nginx/nginx-0.5.35.tar.gz<br />
./tar zxvf nginx-0.5.35.tar.gz<br />
./configure --with-md5=/usr/lib --with-sha1=/usr/lib<br />
make <br />
sudo make install</pre><br />
設定ファイルを編集します。<br />
<pre class="code">vi /usr/local/nginx/conf/nginx.conf<br />
http {<br />
  upstream mongrel_cluster {<br />
    server localhost:4000;<br />
    server localhost:4001;<br />
  }<br />
  server {<br />
        root   html;<br />
        location / {<br />
            proxy_pass http://mongrel_cluster;<br />
        }<br />
  }<br />
}</pre><br />
 設定ファイルのフォーマット等テストをします。<br />
<pre class="code">sudo /usr/local/nginx/sbin/nginx -t<br />
2008/02/06 20:47:55 [info] 4249#0: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok<br />
2008/02/06 20:47:55 [info] 4249#0: the configuration file /usr/local/nginx/conf/nginx.conf was tested successfully</pre><br />
起動します<br />
<pre class="code">sudo /usr/local/nginx/sbin/nginx</pre><br />
設定ファイルを以下のようにすれば静的ファイルは nginxが出力したりと、LVSと比べて Layer7の部分でいろいろできるかもしれないです。<br />
<pre class="code">  server {<br />
    root   html;<br />
    if (-f $request_filename) {<br />
      rewrite (.*)$1 break;<br />
    }<br />
    if (!-f $request_filename) {<br />
        proxy_pass http://mongrel_cluster;<br />
      break;<br />
    }<br />
  }</pre><br />
<br />
<br />
-追記-<br />
ごめんなさい　書いてから気がついたのですが<br />
http://www.slideshare.net/zhesto/rails-deployment-with-nginx<br />
とほとんど同じ内容でした。
{% endraw %}
