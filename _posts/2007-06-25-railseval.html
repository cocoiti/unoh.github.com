---
layout: post
title: "railsのテストをevalを駆使して楽しよう"
---
{% raw %}
こんにちは satoです。<br /><br />　testコードではパフォーマンスやセキュリティをさほど気にすることはないと思うので、testコードで evalを使って楽できるケースを書いてみたいと思います。<br /><br />　　よく似たModel で Userと Admin があるとします。　二つの Model には confirm というメソッドが定義されていて、ユーザ登録をしてメールで送られてくる URLを　をクリックすると status が 'register' から 'confirm' に変更されます。<br /><br /><pre class="code"><br />  class UserTest < Test::Unit::TestCase<br />    def test_with_confirm<br />      user = User.find(:first, :conditions => ["status = ?", 'register'])<br />      user.confirm<br />      assert(user.status == 'confirm', 'confirm error')<br />    end<br />  end<br /></pre><br /><br />というテストをUserTest　と AdminTest に書きます。<br /><br />しかし以下のような moduleを継承しておくと DRYに書けます<br /><br /><pre class="code"><br />  module UserModelTestHelper<br />    def get_class<br />      k = self.class.to_s.gsub(/Test$/, '')<br />      eval k<br />    end<br />    def test_with_confirm<br />      user = get_class.find(:first, :conditions => ["status = ?", 'register'])<br />      user.confirm<br />      assert(user.status == 'confirm', 'confirm error')<br />    end<br />  end<br /></pre><br /><br />このようなクラスを定義しておくと module を incude するだけで 勝手にテストが生成されます。<br /><br /><pre class="code"><br />  class TestUser < Test::Unit::TestCase<br />    include UserModelTestHelper <br />  end<br />  class TestAdmin < Test::Unit::TestCase<br />    include UserModelTestHelper<br />  end<br /></pre><br /><br />　同じような 共通のテストは UserModelTestHelperにどんどん追加するだけです。<br /><br />　上記の例では クラス名を evalで Modelに変換していますが、テストファイル名やメソッド名を利用すると同じように楽できるケースがあると思います。。またUnitテストだけではなく Rspecなどにも普通に使えるのでNiceな方法を思いついたらぜひ教えてください
{% endraw %}
