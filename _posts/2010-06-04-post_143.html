---
layout: post
title: "iPhone SDKでウェブAPIコール"
---
{% raw %}
今さらですが最近iPhone SDKプログラミングを始めたBrandonです。<br />
<br />
勉強目的に簡単なアプリ作ろうと思って、今個人的にとても気に入っているウェブサービス(<a href="http://posterous.com/">Posterous</a>)のiPhoneアプリを作っています。<br />
アプリでWeb APIリクエスト・レスポンスの処理をする必要があったので、<br />
ド素人ですが下記のような感じで初期実装してみました。<br />
暇がある時に遊び心で触っている程度だけなので、やり方が間違っているところもたくさんあるかも知れないが、何かご指摘があれば遠慮なく突っ込んで頂けるとありがたいです。<br />
<br />
<h3>導入したライブラリ</h3><br />
最初に問題になったのは、Posterous APIはBasic Authentication使っていますが、調べてみたところObjective Cにはbase64エンコードのライブラリがないことが判明しました。<br />
そこで、<a href="http://iphoneonrails.com">Objective Resource</a>という良さそうなフレームワークを見つけたので、それを導入しました。（base64エンコードのためにそこまでする必要はないが、他にも勉強になりそうな部分があるフレームワークなのでそういうところを含めて入れてみました。）<br />
<br />
XMLの解析には、Googleの<a href="http://code.google.com/p/gdata-objectivec-client/downloads/list">GDataXML</a>を使用しました。<br />
<br />
今回は、Posterousの<a href="http://posterous.com/api/posting">getSites API</a>をコールします。<br />
<br />
<h3>リクエスト処理クラス</h3><br />
リクエスト周りの処理はPosterousRequest.hとPosterousRequest.mにまとめました。<br />
<pre class="code"><br />
//<br />
//  PosterousRequest.h<br />
//<br />
<br />
#import &lt;Foundation/Foundation.h&gt;<br />
#import "NSData+Additions.h" //Objective Resourceから<br />
<br />
@interface PosterousRequest : NSObject {<br />
	//受信データを保存する変数<br />
	NSMutableData *receivedData; <br />
}<br />
<br />
@property(nonatomic,retain) NSMutableData *receivedData;<br />
<br />
//PosterousのgetSites APIコール<br />
- (void)getSites:(NSString*)username password:(NSString*)password; <br />
<br />
- (void)dealloc;<br />
<br />
//受信する時に呼び出される関数<br />
- (void)connection:(NSURLConnection *)connection didReceiveResponse:(NSURLResponse *)response;<br />
<br />
@end</pre><br />
<br />
PosterousRequest.m<br />
<br />
<pre class="code"><br />
//<br />
//  PosterousRequest.m<br />
//<br />
<br />
#import "PosterousRequest.h"<br />
#import "PosterousAppDelegate.h"//アプリケーションのメインコントローラ<br />
#import "GDataXMLNode.h" //GoogleのXML処理ライブラリ<br />
<br />
@implementation PosterousRequest<br />
<br />
//@synthesizeはクラスの基本的なgetやset関数を自動的に生成してくれます<br />
@synthesize receivedData; <br />
<br />
/**<br />
 * リクエスト(requestObj)に認証情報をつける関数<br />
 * http://www.wetware.co.nz/blog/2009/02/iphone-uiwebview-http-basic-authentication/<br />
 */<br />
- (void) addAuthToWebRequest:(NSMutableURLRequest*)requestObj username:(NSString*)username password:(NSString*)password{<br />
	<br />
	//ここでobjective resourceのライブラリが使われます<br />
	NSString *authString = [[[NSString stringWithFormat:@"%@:%@", username, password] dataUsingEncoding:NSUTF8StringEncoding] base64Encoding];<br />
	<br />
	authString = [NSString stringWithFormat: @"Basic %@", authString];<br />
	<br />
	[requestObj setValue:authString forHTTPHeaderField:@"Authorization"];<br />
}<br />
<br />
/**<br />
 * リクエストを送信する<br />
 */<br />
- (void)sendRequest:(NSString*)address username:(NSString*)username password:(NSString*)password {<br />
	<br />
	//リクエストの初期設定<br />
	NSString *urlString = [NSString stringWithFormat:address];<br />
	NSMutableURLRequest *request = [[[NSMutableURLRequest alloc] init] autorelease];<br />
	[request setURL:[NSURL URLWithString:urlString]];<br />
	[request setHTTPMethod:@"POST"];<br />
	<br />
	//上記のaddAuthToWebRequestで認証情報をリクエストに追加します<br />
	[self addAuthToWebRequest:request username:username password:password];<br />
	<br />
	/*<br />
	  Bodyなどの設定<br />
	*/<br />
<br />
	NSLog(@"connection attempted");<br />
	//PS:"@"はchar*をObjective CのNSStringにコンバートします＋Unicode対応をつける<br />
	<br />
	[NSURLConnection connectionWithRequest:request delegate:self];<br />
} <br />
<br />
//getSites APIリクエスト<br />
-(void)getSites:(NSString*)username password:(NSString*)password {<br />
	[self sendRequest:@"https://posterous.com/api/getsites"username:username password:password];<br />
}<br />
<br />
//最初にレスポンスが来たとき一度だけだけ実行されます<br />
- (void)connection:(NSURLConnection *)connection didReceiveResponse:(NSURLResponse *)response {<br />
<br />
	//receivedDataを初期化してデータ受信の準備をする<br />
	receivedData = [[NSMutableData alloc]init];<br />
	[receivedData setLength:0];<br />
	NSLog(@"Set received data length to 0");<br />
	<br />
	//レスポンスのヘッダー情報をNSLogでコンソールに出力して確認する<br />
	if ([response respondsToSelector:@selector(allHeaderFields)]) {<br />
		NSLog(@"response header");<br />
		NSHTTPURLResponse *httpResponse = (NSHTTPURLResponse*)response;<br />
		NSDictionary *dictionary = [httpResponse allHeaderFields];<br />
		NSLog(@"%@", [dictionary description]);<br />
	}<br />
}<br />
<br />
//受信したデータをreceivedDataに保存する<br />
-(void)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data {<br />
	[receivedData appendData:data];<br />
}<br />
<br />
//レスポンスが終了したときに実行されます<br />
-(void)connectionDidFinishLoading:(NSURLConnection *)connection {<br />
	NSError *error;<br />
	NSLog(@"succeeded! received %d bytes of data", [receivedData length]);<br />
	GDataXMLDocument *doc = [[GDataXMLDocument alloc] initWithData:receivedData options:0 error:&error];<br />
	if (doc != nil) {<br />
		/*<br />
		 ...<br />
		 レスポンス解析<br />
		 ...<br />
		 */<br />
	}<br />
<br />
	/*  <br />
	  ..<br />
	  画面遷移処理など<br />
	  ..<br />
	*/<br />
	[doc release];<br />
	[receivedData release];<br />
}<br />
<br />
-(void)dealloc {<br />
	[receivedData release];<br />
	[super dealloc];<br />
}<br />
<br />
@end<br />
</pre><br />
<br />
実際にコントローラでAPIをコールするときの例：<br />
<pre class="code"><br />
posterousRequest = [[PosterousRequest alloc] init];<br />
[posterousRequest getSites:self.username.text password:self.password.text];<br />
[posterousRequest release];<br />
</pre><br />
<br />
以上です！<br />
<br />
<div style="margin:0;padding:.5em;border:2px solid #ccc">ウノウでは特に最近、積極的にエンジニアを採用しています。<br /><br />
<a href="http://www.unoh.net/recruit.html">採用ページ</a>をご覧になり興味のある方、ぜひご応募ください。<br/><br />
<a href="http://www.find-job.net/fj/showjob.cgi?id=50212">Find Job!</a>でも募集してます！</div>
{% endraw %}
